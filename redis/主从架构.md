
redis 提供了 **主从复制模式**，所有的数据修改只在主服务器上进行，然后将最新的数据同步给从服务器。

## 主从同步

### 第一次同步

可以使用 **replicaof (redis 5.0 之前使用 slaveof)** 命令形成主服务器和从服务器的关系。例如，现有服务器 A 和服务器 B，要将服务器 B 变为服务器 A 的 **从服务器**，则在服务器 B 上执行以下命令：

```shell
# 服务器 B 执行这条命令
replicaof <服务器A的IP地址> <服务器A的redis端口号>
```

主从服务器的第一次同步的过程可分为三个阶段：

1. 第一阶段是[建立链接、协商同步](#第一阶段：建立链接、协商同步)
2. 第二阶段是主服务器同步数据给从服务器
3. 第三阶段是主服务器发送新的写操作命令给从服务器

[img 主从第一次同步的三个阶段](../images/主从第一次同步的三个阶段.webp)

#### 第一阶段：建立链接、协商同步

执行 replicaof 命令后，从服务器会给主服务器发送 **psync** 命令，表示要进行数据同步

psync 命令包含两个参数，分别是主服务器的 **runID** 和复制进度 **offset**

1. runID，每个 redis 服务器在启动时都会自动生产一个随机的 ID 用于唯一标识自己。当从服务器和主服务器第一次同步时，因为不知道主服务器的 runID，所以将其设置为 "?"
2. offset，表示复制的进度，第一次同步时，其值为 -1

主服务器收到 psync 命令后，会用 **FULLRESYNC** 作为响应命令返回给对方，并且这个响应命令会带上两个参数：主服务器的 runID 和主服务器目前的复制进度 offset。从服务器收到这个响应后，会记录这两个值

FULLRESYNC 响应命令的意图是采用 **全量复制** 的方式，也就是主服务器会把所有的数据都同步给从服务器