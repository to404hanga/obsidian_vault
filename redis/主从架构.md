
redis 提供了 **主从复制模式**，所有的数据修改只在主服务器上进行，然后将最新的数据同步给从服务器。

## 主从同步

### 第一次同步

可以使用 **replicaof (redis 5.0 之前使用 slaveof)** 命令形成主服务器和从服务器的关系。例如，现有服务器 A 和服务器 B，要将服务器 B 变为服务器 A 的 **从服务器**，则在服务器 B 上执行以下命令：

```shell
# 服务器 B 执行这条命令
replicaof <服务器A的IP地址> <服务器A的redis端口号>
```

主从服务器的第一次同步的过程可分为三个阶段：

1. 第一阶段是[建立链接、协商同步](#第一阶段：建立链接、协商同步)
2. 第二阶段是[主服务器同步数据给从服务器](#第二阶段：主服务器同步数据给从服务器)
3. 第三阶段是[主服务器发送新的写操作命令给从服务器](#第三阶段：主服务器发送新的写操作命令给从服务器)

[img 主从第一次同步的三个阶段](../images/主从第一次同步的三个阶段.webp)

#### 第一阶段：建立链接、协商同步

执行 replicaof 命令后，从服务器会给主服务器发送 **psync** 命令，表示要进行数据同步

psync 命令包含两个参数，分别是主服务器的 **runID** 和复制进度 **offset**

1. runID，每个 redis 服务器在启动时都会自动生产一个随机的 ID 用于唯一标识自己。当从服务器和主服务器第一次同步时，因为不知道主服务器的 runID，所以将其设置为 "?"
2. offset，表示复制的进度，第一次同步时，其值为 -1

主服务器收到 psync 命令后，会用 **FULLRESYNC** 作为响应命令返回给对方，并且这个响应命令会带上两个参数：主服务器的 runID 和主服务器目前的复制进度 offset。从服务器收到这个响应后，会记录这两个值

FULLRESYNC 响应命令的意图是采用 **全量复制** 的方式，也就是主服务器会把所有的数据都同步给从服务器

#### 第二阶段：主服务器同步数据给从服务器

主服务器执行 **bgsave** 命令生成 RDB 文件，然后把文件发送给从服务器，从服务器收到 RDB 文件后，会先清空当前的数据，然后载入 RDB 文件。为了保证主从服务器的数据一致性，主服务器会将在 RDB 文件生成期间收到的写操作命令，写入到 **replication buffer** 缓冲区中

#### 第三阶段：主服务器发送新的写操作命令给从服务器

在主服务器生成的 RDB 文件发送后，将 replication buffer 缓冲区里所记录的写操作命令发送给从服务器，然后从服务器重新执行这些操作

#### 命令传播

主从服务器在完成第一次同步后，双方之间会维护一个 TCP 连接，后续主服务器可以通过这个连接继续将写操作命令传播给从服务器，然后从服务器执行该命令，使得主从服务器状态相同。该过程被称为 **基于长连接的命令传播**

#### 分摊主服务器的压力

主服务器是可以有多个从服务器的，如果从服务器的数量非常多，且都与主服务器进行全量同步的话，会带来两个问题：

1. 由于通过 bgsave 命令来生成 RDB 文件，那么主服务器会忙于使用 fork() 创建子进程，如果主服务器的内存数据非常大，在执行 fork() 时会阻塞主线程，使得 redis 无法正常处理请求
2. 传输 RDB 文件会占用主服务器的网络带宽，会对主服务器响应命令请求产生影响

redis 从服务器可以有自己的从服务器，不仅可以作为从服务器接收主服务器的同步数据，也可以同时作为主服务器的形式将数据同步给其他从服务器。通过这种方式，主服务器生成 RDB 和传输 RDB 的压力可以分摊到各个中间层级的从服务器上

#### 增量复制

在 redis 2.8 之前，如果主从服务器在命令同步时出现了网络断开又恢复的情况，从服务器就会和主服务器重新进行一次全量复制

从 redis 2.8 开始，网络断开又恢复后，主从服务器会采用 **增量复制** 的方式继续同步，只会把网络断开期间主服务器收到的写操作命令，同步给从服务器

##### 增量复制的三个步骤：

1. 从服务器在恢复网络后，会发送 psync 命令到主服务器，此时 psync 命令的 offset 参数不是 -1
2. 主服务器收到该命令后，用 **CONTINUE** 响应命令告诉从服务器接下来采用增量复制的方式同步数据
3. 主服务器将断线期间，所执行的写命令发送给从服务器，从服务器执行这些命令

##### 如何知道将哪些增量数据发送给从服务器？

1. repl_backlog_buffer：是一个 **环形** 缓冲区，用于主从服务器断连后，从中找到差异的数据
2. replication offset：标记 repl_backlog_buffer 缓冲区的同步进度，主从服务器都有自己的偏移量，主服务器使用 **master_repl_offset** 来记录自己 **写** 到的位置，从服务器使用 **slave_repl_offset** 来记录自己 **读** 到的位置

##### 对从服务器执行哪种同步操作

1. 如果判断出从服务器要读取的数据还在 repl_backlog_buffer 缓冲区中，那么主服务器将采用 **增量同步** 的方式
2. 如果判断出从服务器要读取的数据已经不存在 repl_backlog_buffer 缓冲区中，那么主服务器将采用 **全量同步** 的方式

##### 如何估算 repl_backlog_buffer 最小的大小

```
second * write_size_per_second
```

1. second 为从服务器断线重连所需的平均时间（单位秒）
2. write_size_per_second 为主服务器平均每秒产生的写命令数量大小

##### 如何修改 repl_backlog_buffer 大小

```shell
repl-backlog-buffer 1mb
```

